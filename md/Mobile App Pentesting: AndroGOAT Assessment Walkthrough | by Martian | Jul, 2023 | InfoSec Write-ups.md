> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [infosecwriteups.com](https://infosecwriteups.com/mobile-pentesting-androgoat-assessment-walkthrough-1a63a7edc677)

> Have you ever wondered about the vulnerabilities hidden beneath the surface of your favorite mobile a......

Installation
------------

For this walkthrough I am using a physical android phone and a VM (Genymotion).

You dont have to use my exact method of setup, you can place platform tools and apk file in the same location or provide full path of their location in order to install the AndroGOAT application to run the Android virtual machine.

![](https://miro.medium.com/v2/resize:fit:469/1*tLIaGBiTKHbJqXrwO70XIw.png)

Either you can Drag and Drop the APK file of AndroGoat on Android VM or you can install it with Android Debug Bridge (adb).

**Installation with ADB:**

Open Command Prompt and Navigate to the location of AndroGoat APK file.

![](https://miro.medium.com/v2/resize:fit:703/1*Sk3uGLU9Cq76tGZ2-pFHCg.png)

Now run following command:

```
adb devices

```

This command will show us status of any android device running on our system

![](https://miro.medium.com/v2/resize:fit:679/1*Cy9YfxQgurdAJAg32JY5WQ.png)

As VM which we started earlier is running, now it’s time to install AndroGoat application. Run command given below and shown in figure

```
adb install AndroGoat.apk

```

You will get success status printed on command line:

![](https://miro.medium.com/v2/resize:fit:631/1*yV9UESKfI1L6gFt8DrGL-Q.png)

Icon of AndroGoat app will also appear on your VM as shown below:

![](https://miro.medium.com/v2/resize:fit:461/1*QtbhgmXT5ObxzQjeMGJlLw.jpeg)

Tap (Click) on the AndroGoat app Icon to launch the application.

![](https://miro.medium.com/v2/resize:fit:500/1*mlHfF8mpSykobLUP8qxW3Q.png)

**1. HTTP**

Setup a proxy on mobile phone like this:

![](https://miro.medium.com/v2/resize:fit:335/1*kq7aK0B9fi3_HeXwKaILfg.png)

192.168.18.231 is the IP address of my computer which is connected with internet.

![](https://miro.medium.com/v2/resize:fit:561/1*UlWD59SHrPNmgt3ZqrlorA.png)

Start Burpsuite and enter the proxy details in proxy listener section:

![](https://miro.medium.com/v2/resize:fit:678/1*xRlQ4eqGFCCcxZ3lzk6drg.png)

Then open the AndroGoat application and click on HTTP and the traffic will be intercepted in Burpsuite:

![](https://miro.medium.com/v2/resize:fit:780/1*gQ8Tg4jo4naSAAUqIoI7hQ.png)

**2. Intercepting HTTPS**

For task 2, we need to export Burpsuite SSL certificate to mobile phone, so that HTTPs based traffic can be intercepted. Certificate exporting option is shown below.

![](https://miro.medium.com/v2/resize:fit:780/1*f0NUHUkRTPcTKowd3lI19Q.png)

Enter the name of file with extension of .cer:

![](https://miro.medium.com/v2/resize:fit:733/1*BtIN9hKELFVDLcMfEPiXew.png)

Transfer burp.cer to the mobile phone files folder and then Go to certificate option in mobile phone settings.

![](https://miro.medium.com/v2/resize:fit:381/1*rdhvTCYEVjMSWK3pE76Xrw.png)

Phone types and menus vary but if you are having issues finding the certificate menu then try to search for “certificate”:

![](https://miro.medium.com/v2/resize:fit:375/1*FMkX-R36OGK5bdunWYcC3Q.png)

After the certificate is installed on the mobile phone, navigate to the folder where the certificate is stored.

![](https://miro.medium.com/v2/resize:fit:375/1*51ZN9aPO8CZ1Fv7jNokZZg.png)

Click on certificate and install it, select the option “VPN and Apps” using any preferred name and press OK:

![](https://miro.medium.com/v2/resize:fit:380/1*w-jO91RIcJ8-L6AqIjjq2g.png)

Now go to the application and click on https. Wait about 5–10 seconds and [**https://owasp.org**](https://owasp.org/) will be intercepted by Burpsuite:

![](https://miro.medium.com/v2/resize:fit:780/1*O6zPrklF6g86Dx1bTd3qkw.png)

**3. Certificate Pinning**

What we want to do here is install Frida Server and send the server file to the rooted android phone location **_/data/local/tmp_**.

![](https://miro.medium.com/v2/resize:fit:758/1*90r07NLhPX5crWxAWEGwDg.png)

Install Frida tools on windows/ linux system as shown below:

![](https://miro.medium.com/v2/resize:fit:758/1*DhQg6uk2ZZZx0mpHRUO1uQ.png)

Now go to android phone location and run the command:

```
chmod +x frida-server-16.0.9-android-arm64

```

After running the above command, type the following command to run Frida server.

![](https://miro.medium.com/v2/resize:fit:800/1*gGpsk3Jcn6T7WrKegEAY4A.png)

Run the following command on windows/linux system to check if Frida is installed correctly.

![](https://miro.medium.com/v2/resize:fit:741/1*uv-V-7Dld6bjeZdXD3SWrA.png)

Now install the [objection framework](https://github.com/sensepost/objection) and run it on the host PC system.

![](https://miro.medium.com/v2/resize:fit:759/1*7MwIZGxtow8FxIP8StSliw.png)

Run the following command to bypass SSL/ Certificate pinning on AndroGOAT Application.

```
objection –g owasp.sat.agoat explore –s “android sslpinning disable”

```

![](https://miro.medium.com/v2/resize:fit:759/1*_Bh9WxQKefznUieIxRCC4w.png)

Now click on certificate pinning in AndroGOAT:

![](https://miro.medium.com/v2/resize:fit:760/1*sV1BQFSbNWC2mJH1d8bfcA.png)

According to this code, if the correct pin is inserted then **AccessControl1ViewActivity** will be called:

![](https://miro.medium.com/v2/resize:fit:783/1*ICePuTy5O9qCFZwLj_AeOQ.png)

Instead of providing the correct pin, the user can directly jump to the **AccessControl1ViewActivity** by using the following command:

```
adb shell am start -n owasp.sat.agoat/.AccessControl1ViewActivity

```

![](https://miro.medium.com/v2/resize:fit:780/1*nwC7eKHfEEUwNGuo8OuTfg.png)

After running the command successfully, the following activity will be shown:

![](https://miro.medium.com/v2/resize:fit:376/1*T5EsX9ogbI1fmOVFgOgBIQ.png)

1.  **Shared Preferences(Part 1)**

In this task, input the username and password of activity and then click on save.

![](https://miro.medium.com/v2/resize:fit:384/1*gSsZ-ZUr19mHu-pAsMtf-Q.png)

Go into android shell by typing the following commands

```
adb shell > su > cd /data/data/owasp.sat.agoat/shared_prefs

```

Then type ls command to list all files and you should see interesting files including users.xml. :)

Show the content of the xml files with cat or nano:

```
cat users.xml

```

![](https://miro.medium.com/v2/resize:fit:544/1*S-aB7gr1EYJjdbbAdWijgA.png)

**2. Shared Preferences (Part 2)**

Click on “shared preferences — Part 2” to open a score card.

![](https://miro.medium.com/v2/resize:fit:366/1*XUUVEjeQP6epdL-jufJyMQ.png)

Now go to **/data/data/owasp.sat.agoat/shared_prefs**

Type the **ls** command and there will be new file present there named **score.xml**.

![](https://miro.medium.com/v2/resize:fit:525/1*zp_ErCZPcqKsxN52u6G-Lg.png)

Now edit the score.xml file either by exporting it or by editing it in the location and values will be reflected on the activity page as shown below:

![](https://miro.medium.com/v2/resize:fit:576/1*hLtgMFAlwIc4Bkn3_Y1tlQ.jpeg)![](https://miro.medium.com/v2/resize:fit:495/1*DnzaVyuCPDVL7tzbNyH24g.jpeg)

**3. SQLite**

Next in the Insecure Data Storage section, go to SQLite and enter any username and password and click on Save option.

![](https://miro.medium.com/v2/resize:fit:381/1*aLn2eeJsTVVI6B7m1Phx3w.png)

Now go to **cd /data/data/owasp.sat.agoat/databases** and type **ls –l** to list databases.  
After that type **sqlite3 <database_name>** , list tables using the command, **.tables**, and enumerate the table contents by typing **select * from users**;

![](https://miro.medium.com/v2/resize:fit:766/1*-8gB-sF86Qng5irJv8jNOA.png)

**4. Temp File**

The temp file is created when a user enters username and password.

![](https://miro.medium.com/v2/resize:fit:376/1*cbRylaQ9VlYws1T8rCDzag.png)

After the temp file is created in the application container, go to the application container by **cd /data/data/owasp.sat.agoat/** and then type **ls –l.**

Display the contents of the file **users*tmp** and it will list the sensitive contents (i.e. username/password) in plaintext.

![](https://miro.medium.com/v2/resize:fit:738/1*9gP7X0dDqXoWx-LBa23lBQ.png)

**5. External Storage — SDCard**

![](https://miro.medium.com/v2/resize:fit:379/1*Z3Wfi5_Q7l7SWEyc2e2vCg.png)

For this one, ensure that you have granted permissions to the mobile application as shown here:

![](https://miro.medium.com/v2/resize:fit:380/1*sHDhfrvu7eun1wxX1lWXXQ.png)

Now to take a look at the code, open the .apk AndroGoat file in jadx tool and go to **InsecureStorageSDCardActivit**y.

![](https://miro.medium.com/v2/resize:fit:743/1*EiEUKzYuRuPG2km1W7R1dg.png)

As shown in the red box, the data is going to be stored in SDCARD (external storage) with name “**users”** prefix **“tmp”** as postfix and **input userinfo** will be stored there.

Now access the device with **adb shell > su > cd /sdcard/** and type **ls –l** and cat users*tmp.

![](https://miro.medium.com/v2/resize:fit:743/1*OQFbPHC0U1WRW7U6A_XGTw.png)

1.  **Cross-Site Scripting (XSS)**

XSS (Cross Site Scripting) attacks are a type of injection, in which malicious scripts are injected into otherwise benign and trusted websites. In this case due to lack of input validation any simple/ complex script written in the input text field will be reflected back to user. Like for example write a javascript line i.e <script>alert(‘hello’)</script>

![](https://miro.medium.com/v2/resize:fit:379/1*gMbGJxReHT8wi20PZlhpvw.png)

**2. SQL Injection (SQLi)**

SQL Injection (SQLi) is a common attack vector that uses malicious SQL code for backend database manipulation to access information that was not intended to be displayed.

Following is the screenshot of the code running behind this SQLIActivity, as depicted in the code, there is no input validation on username and if any person enters special chars, then it will get reflected into database or data will be retrieved from database.

![](https://miro.medium.com/v2/resize:fit:783/1*YlrnL0LZATOimzI2n7nH6Q.png)

As shown below input **‘ or 1=1 —** it will fetch data from database because of lack of input validation whilst fetching data from database. It will enumerate all values from database (aGoat) and list all users.

![](https://miro.medium.com/v2/resize:fit:373/1*psRrPI90YmwkMRTj_tibIA.png)

**3. WebView**

In web view activity, due to lack of input validations and lack of **setAllowFileAccess** parameter and javascript is enabled, so it will display user sensitive info from application container, if exact path is entered.

![](https://miro.medium.com/v2/resize:fit:773/1*6q-jSZLPoEzM2VYGW9sZ_w.png)

Enter exact path of any sensitive resource with prefix **file:///,** as shown in following application screenshot.

![](https://miro.medium.com/v2/resize:fit:373/1*Tvc_4JvucaAaDjFcO4g81g.png)

1.  **Keyboard Cache**

Keystrokes are logged in a particular location of application context as shown:

![](https://miro.medium.com/v2/resize:fit:780/1*LXBhUWC6HakKx41N7ejjKw.png)

Open the keyboard cache and type in some simple phrases in the username and password fields.

![](https://miro.medium.com/v2/resize:fit:381/1*xqsx16v6AzYHP3yE7ZarLw.png)

Go the shell of android phone and navigate to user history by using the below location:

```
adb shell
su
cd /data/data/com.google.android.inputmethod.latin/files/personal/userhistory

```

Now cat out the contents of **UserHistory.en_GB.dict** as shown in subsequent pictures. (However, if your keyboard input language is different then it will show with different name here.)

![](https://miro.medium.com/v2/resize:fit:780/1*8bNhuIc-W8ezOHpqN7dZ6g.png)![](https://miro.medium.com/v2/resize:fit:780/1*uHfO5p9qVyPbPriRAPoj4A.png)

In the contents of userhistory.en_GB.dict you will see the keystrokes strokes input by the user, which was me in this case:

![](https://miro.medium.com/v2/resize:fit:780/1*oAZWe_GGpMIgVJJagaFsMg.png)

**2. Insecure Logging**

First inspect the code by going into **InsecureLoggingActivity** in Jadx and study the code as shown below.

![](https://miro.medium.com/v2/resize:fit:736/1*vJoy--etzRJvR6IblDbyNg.png)

As shown in the picture figure, **Log.e** is logging username and password into log of the application.

Now just type **adb logcat** and enter any credentials in GUI of application as shown below and keep the adb logcat running.

In the logcat activity logs, the details of usernames and passwords will be displayed in text.

![](https://miro.medium.com/v2/resize:fit:379/1*BRKrn-a6lkAzfW5cXaHZKw.png)![](https://miro.medium.com/v2/resize:fit:759/1*M9rcQMNU7WH9OKSx92ctyw.png)

**3. Clipboard — Copy and Paste**

Insert some test numbers for a credit card like this:

![](https://miro.medium.com/v2/resize:fit:375/1*bq4ukt5rmnqVev8Vq2KKcw.png)

For the security flaw in this area, the sensitive data is wrongfully being displayed in plaintext (ClipboardActivity).

![](https://miro.medium.com/v2/resize:fit:783/1*XS3CBMqWpubiVsSS7COLVg.png)![](https://miro.medium.com/v2/resize:fit:248/1*TBCy56LbMsQNrlbS8SuAtA.png)

Inspect the **IsRooted** activity as shown below:

![](https://miro.medium.com/v2/resize:fit:875/1*tEU91pWErJ-SwXbqWoB5zw.png)

There are number of ways to bypass these checks, like using RootCloak, Frida scripts and Magisk. However, we will use the Objection Framework tool already used by us in the **Certificate Pinning activity**. Now, run the Frida server as already shown and type the following command to bypass the root detection:

```
objection –g owasp.sat.agoat explore –s "android root disable"

```

The command above is only different from the objection certificate pinning command at the string “**root”.**

![](https://miro.medium.com/v2/resize:fit:875/1*FeH1qQJPhw62yvNd9AXyFA.png)

After successfully running the command, go to the root activity and it will now get successfully bypassed:

![](https://miro.medium.com/v2/resize:fit:376/1*603A8Hr1R-rfHASN6NhsZA.png)

While reviewing the emulator detection code and you will find that the **isEmulator()** function code contains the logic to check for detection of an emulator.

![](https://miro.medium.com/v2/resize:fit:875/1*n6Bh_kFkoOiC11aLm3D3ng.png)

Now, open objection framework and the application:

```
objection -g owasp.sat.agoat explore

```

![](https://miro.medium.com/v2/resize:fit:875/1*H6lkSN0O1Tb2UDlH8otaog.png)

You should be able to list all the class methods with the following command:

```
android hooking list class_methods owasp.sat.agoat.EmulatorDetectionActivity

```

![](https://miro.medium.com/v2/resize:fit:875/1*hXLi3AE8dI7S2_hy0eEd8g.png)

In the above mentioned you will see to that all class methods of **EmulatorDetectionActivity** are listed in the figure. Now, hook the method isEmulator using following command:

```
android hooking set return_value owasp.sat.agoat.EmulatorDetectionActivity.isEmulator false

```

![](https://miro.medium.com/v2/resize:fit:875/1*iiBYn3uiyo6yBB-jQhrpKw.png)

Now click on check emulator activity and it will display that the device is not an emulator:

![](https://miro.medium.com/v2/resize:fit:379/1*EFkT8VnLu2lbOPJpvm_IMQ.png)

Binary Patching
---------------

![](https://miro.medium.com/v2/resize:fit:373/1*9vWx8-FDuLGFpZ01No9aTA.png)

Inspect the activity of Binary Patching and understand the logic. Here we want to patch the function **isAdmin()** so that it to returns true.

![](https://miro.medium.com/v2/resize:fit:875/1*53pdgiJ1Q_rmUJZ8dVnYJQ.png)

To decompile this, run apktool with following command:

```
java -jar apktool.jar d -r "C:\Users\Administrator\Downloads\AndroGoat.apk" -f

```

Successfully running the command on Windows should look like this:

![](https://miro.medium.com/v2/resize:fit:753/1*zRpWBATmskRvzdNWcTP-Uw.png)

> File location may vary, depending on the stored location of AndroGoat.apk

Now, view the smali files and navigate to the **BinaryPatchingActivity.smali**

![](https://miro.medium.com/v2/resize:fit:875/1*p-VJXxmRmCtO6Jbc6pfpjA.png)

Now take a look at the line 16 and notice that the **if-ne** (if not equal) is looking for the **isAdminText condition.**

![](https://miro.medium.com/v2/resize:fit:783/1*kapb484AmJGL3ZtaUbS1TA.png)

Change **if-ne** to **if-eq** so that **isAdmin** results into always true as shown below:

![](https://miro.medium.com/v2/resize:fit:875/1*eXOmQ3qMwhUSO7y8_7UgKw.png)

Now save the file and build the application folder (AndroGoat) with apktool using this command:

```
java -jar apktool.jar b -r AndroGoat/ -o test.apk

```

Download and run [**uber-apk-signer**](https://github.com/patrickfav/uber-apk-signer) with following command in order to properly sign and zipalign the output file test.apk:

```
java -jar uber-apk-signer-1.3.0.jar --apks test.apk

```

> Note: The above version 1.3.0 may vary depending on when you do this

Now install the output application, **test-aligned-debugSigned.apk** in the android phone.

Now open the application and go to binary patching and you will see “You are admin now”, signifying that application is successfully patched.

![](https://miro.medium.com/v2/resize:fit:513/1*pOxl8LkXO9n6673o1BK8wg.png)